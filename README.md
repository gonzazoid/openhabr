# openhabr
openhabr.net engine

В общем это движок открытого хабра - [openhabr.net](http://openhabr.net/)

Открытого в том смысле что сообщество (если таковое соберется) - само будет решать, куда развивать проект. Само внедрять нужные фишки, голосованием принимать или отклонять пулл-реквесты и прочая демократия. Звучит конечно утопично, но может сначала попробуем?

Пока все простенько, на коленках, лишь бы работало.
Если хотите присоединиться - буду только рад.

Ниже - курс молодого бойца для желающих поразвивать проект. Здесь - только детали реализации движка. Если интересуют подробности устройства сообщества, правила, идеи и прочее - можно посмотреть здесь http://openhabr.net/post/1/

Стек проекта - nginx, node.js, postgresql, шаблонизатор - [mustache](https://github.com/janl/mustache.js)

Для начала структура проекта:

в корне лежат утилиты для деплоя и директории dev и src.
Директория dev содержит стафф для разработчиков, здесь мы видим:
- [/dev/example.js](https://github.com/gonzazoid/openhabr/blob/master/dev/example.js) - шаблон серверного скрипта, на базе которого можно писать свои скрипты.

Директория src содержит все исходники сайта:
- [/src/node/](https://github.com/gonzazoid/openhabr/tree/master/src/node) - серверные скрипты и mustache-шаблоны
- [/src/sql/](https://github.com/gonzazoid/openhabr/tree/master/src/sql) - структура базы и хранимые процедуры, дамп структуры базы лежит в [/src/sql/dump.sql](https://github.com/gonzazoid/openhabr/tree/master/src/sql)
- [/src/static/](https://github.com/gonzazoid/openhabr/tree/master/src/static) - все что отдается nginx-ом самостоятельно (css, шрифты, картинки, клиентские скрипты)

Собственно все. Теперь перейдем на сайт [openhabr.net](http://openhabr.net/). Да, верстка вся временно позаимствована, это нехорошо, я знаю. Как руки дойдут - поменяю, а еще лучше если найдется волонтер-верстальщик, который прикрутит нормальную (не позаимствованную) верстку.

Обратите внимание на красные ссылки - эти разделы еще не реализованы. Например раздел "хабы" в футере страницы. Ок, сделаем доброе дело, поможем проекту.
Исходим из того что сам проект у нас уже форкнут и развернут.

Смотрим в оригинале - на этой странице выводится список хабов с коротким комментированием, отсортированный в порядке убывания рейтинга хаба. На каждый хаб выводится: число подписчиков, количество публикаций, до 10-ти популярных тем и индекс хаба.

Что же, создадим скрипт, дергающий это все с базы и отдающий пользователю.
Итак, мы хотим реализовать вывод по адресу /hubs/.
- Откроем [/conf/nging.conf](https://github.com/gonzazoid/openhabr/blob/master/conf/nginx.conf) Как видим, в списке локаций /hubs/ отсутствует, а значит нужна новая нода.
- Скопируем [/dev/example.js](https://github.com/gonzazoid/openhabr/blob/master/dev/example.js) в директорию [/src/node/](https://github.com/gonzazoid/openhabr/tree/master/src/node) под именем hubs.js (логично)
- пропишем ноду в nginx-е, добавив следующую строку: `location /hubs/ { proxy_pass http://localhost:7506/; }`. Порт берем первый свободный, некритично. В дальнейшем это будет автоматом прописываться при сборке gulp-ом, пока так, не страшно.
- пропишем новую ноду в start и stop скриптах:
  в start добавим строку:

`forever -a --minUptime 1000 --spinSleepTime 1000  -l "$logs/hubs.log"       --pidFile "$pids/hubs.pid"       start hubs.js`

в stop:

`forever -a -l "$logs/hubs.log"       --pidFile "$pids/hubs.pid"      stop hubs.js`

Все, нода прописана, можно приступить к программированию. Открываем /src/node/hubs.js

nginx ждет ноду на 7506-ом порту, пропишем сразу это в ноде. В конце файла у нас есть строка запуска http сервера - заменим вопросительные знаки нашим портом:

<pre>
http.createServer(dispatcher).listen(7506, "localhost");
console.log('hubs.server running at http://localhost:7506');
</pre>
