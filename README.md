# openhabr
openhabr.net engine

В общем это движок открытого хабра - [openhabr.net](http://openhabr.net/)

Открытого в том смысле что сообщество (если таковое соберется) - само будет решать, куда развивать проект. Само внедрять нужные фишки, голосованием принимать или отклонять пулл-реквесты и прочая демократия. Звучит конечно утопично, но может сначала попробуем?

Пока все простенько, на коленках, лишь бы работало.
Если хотите присоединиться - буду только рад.

Ниже - курс молодого бойца для желающих поразвивать проект. Здесь - только детали реализации движка. Если интересуют подробности устройства сообщества, правила, идеи и прочее - можно посмотреть здесь http://openhabr.net/post/1/

Стек проекта - nginx, node.js, postgresql, шаблонизатор - [mustache](https://github.com/janl/mustache.js)

Для начала структура проекта:

в корне лежат утилиты для деплоя и директории dev и src.
Директория dev содержит стафф для разработчиков, здесь мы видим:
- [/dev/example.js](https://github.com/gonzazoid/openhabr/blob/master/dev/example.js) - шаблон серверного скрипта, на базе которого можно писать свои скрипты.

Директория src содержит все исходники сайта:
- [/src/node/](https://github.com/gonzazoid/openhabr/tree/master/src/node) - серверные скрипты и mustache-шаблоны
- [/src/sql/](https://github.com/gonzazoid/openhabr/tree/master/src/sql) - структура базы и хранимые процедуры, дамп структуры базы лежит в [/src/sql/dump.sql](https://github.com/gonzazoid/openhabr/tree/master/src/sql)
- [/src/static/](https://github.com/gonzazoid/openhabr/tree/master/src/static) - все что отдается nginx-ом самостоятельно (css, шрифты, картинки, клиентские скрипты)

Собственно все. Теперь перейдем на сайт [openhabr.net](http://openhabr.net/). Да, верстка вся временно позаимствована, это нехорошо, я знаю. Как руки дойдут - поменяю, а еще лучше если найдется волонтер-верстальщик, который прикрутит нормальную (не позаимствованную) верстку.

Обратите внимание на красные ссылки - эти разделы еще не реализованы. Например раздел "хабы" в футере страницы. Ок, сделаем доброе дело, поможем проекту.
Исходим из того что сам проект у нас уже форкнут и развернут.

Смотрим в оригинале - на этой странице выводится список хабов с коротким комментированием, отсортированный в порядке убывания рейтинга хаба. На каждый хаб выводится: число подписчиков, количество публикаций, до 10-ти популярных тем и индекс хаба.

Что же, создадим скрипт, дергающий это все с базы и отдающий пользователю.
Итак, мы хотим реализовать вывод по адресу /hubs/.
- Откроем [/conf/nging.conf](https://github.com/gonzazoid/openhabr/blob/master/conf/nginx.conf) Как видим, в списке локаций /hubs/ отсутствует, а значит нужна новая нода.
- Скопируем [/dev/example.js](https://github.com/gonzazoid/openhabr/blob/master/dev/example.js) в директорию [/src/node/](https://github.com/gonzazoid/openhabr/tree/master/src/node) под именем hubs.js (логично)
- пропишем ноду в nginx-е, добавив следующую строку: `location /hubs/ { proxy_pass http://localhost:7506/; }`. Порт берем первый свободный, некритично. В дальнейшем это будет автоматом прописываться при сборке gulp-ом, пока так, не страшно.
- пропишем новую ноду в start и stop скриптах:
  в start добавим строку:

`forever -a --minUptime 1000 --spinSleepTime 1000  -l "$logs/hubs.log"       --pidFile "$pids/hubs.pid"       start hubs.js`

в stop:

`forever -a -l "$logs/hubs.log"       --pidFile "$pids/hubs.pid"      stop hubs.js`

Все, нода прописана, можно приступить к программированию. Открываем /src/node/hubs.js

nginx ждет ноду на 7506-ом порту, пропишем сразу это в ноде. В конце файла у нас есть строка запуска http сервера - заменим вопросительные знаки нашим портом:

<pre>
http.createServer(dispatcher).listen(7506, "localhost");
console.log('hubs.server running at http://localhost:7506');
</pre>

Разберемся теперь со структурой сервера. Посмотрим с самого начала:

<pre>
var patterns = {
    some_pattern: fs.readFileSync("./tpl/some_pattern.tpl", "utf-8")
   ,footer: fs.readFileSync("./tpl/footer.tpl", "utf-8")
};
</pre>

Здесь мы загружаем нужные нам при работе паттерны.  Футер есть у всех страниц, его оставляем, помимо этого нам видимо понадобится шаблон списка хабов. Ок, заменим строку 

`    some_pattern: fs.readFileSync("./tpl/some_pattern.tpl", "utf-8")`

на 

`    hubs: fs.readFileSync("./tpl/hubs.tpl", "utf-8")`

В голове держим что в директорию /src/node/tpl/ надо добавить шаблон hubs.tpl, к этому моменту мы еще вернемся.

Смотрим дальше. Функция dispatcher - наш обработчик http запроса, на входе два объекта - request и response, все как обычно, если что то непонятно - смотрим [документацию](https://nodejs.org/api/http.html)

А вот в самом диспетчере мы объединяем request и response в один объект job `{request: request, response: response}`. Почему ? Потому что мы делаем конвейер и каждый этап обработки запроса или ответа выносим в отдельную функцию, а что бы нормально chain-ить эти функции - удобно работать с одним объектом и передавать его по очереди, чем с двумя и делать их глобалами. Кроме того - один объект легко поддается промисизации, что и было реализовано.

Что же, смотрим доставшийся нам dispatcher. Подгружаемый модуль bike - это наш велосипед, в котором реализованы общие этапы обработки запроса.
- `prepare_headers` - готовит хидеры ответа, в основном убираем кэширование, в дальнейшем возможно изменим. Тут ничего трогать не надо, если вдруг нужны какие то особые хидеры - их можно добавить на любом этапе.
- `parse_cookies` - парсит куки и складывает их в job.request.cookies, ничего необычного
- `start_session` - на основании полученных кук запускает сессию - тупо подтягивает запись из таблицы users и кладет ее в job.request.user
- `worker` - а это как раз наш обработчик, который мы сейчас начнем реализовывать
- `output` - на основании подготовленных нами данных выводит всю верстку на клиента. Ожидает:
    - `job.response.habr.headers` - хидеры для вывода. Если переменная job.response.habr.status не указана, то выводит эти заголовки со статусом 200 Ok, иначе берет из job.response.habr.status.code и job.response.habr.status.message 
    - `job.response.habr.pattern` - шаблон страницы. Если не указан - вывод не осуществляется (например при редиректах)
    - `job.response.habr.patterns` - вспомогательные шаблоны. Сюда обычно присваивается переменная patterns, в которую грузятся все шаблоны перед стартом сервера (выше мы рассматривали ее)
